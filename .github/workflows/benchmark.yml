name: Performance Benchmark

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: write
  pull-requests: write

jobs:
  benchmark:
    name: Run Startup Benchmark
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build extension
        run: bun run compile --test

      - name: Run benchmark
        run: bun run benchmark
        env:
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF_NAME: ${{ github.ref_name }}

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: .benchmark-results/startup-results.json
          retention-days: 90

      - name: Store baseline results
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/cache/save@v5
        with:
          path: .benchmark-results/startup-results.json
          key: benchmark-baseline-${{ github.sha }}

      - name: Get baseline results
        if: github.event_name == 'pull_request'
        id: baseline
        uses: actions/cache/restore@v5
        with:
          path: .benchmark-results/baseline.json
          key: benchmark-baseline
          restore-keys: benchmark-baseline-

      - name: Compare with baseline
        if: github.event_name == 'pull_request'
        run: |
          if [ -f ".benchmark-results/baseline.json" ]; then
            cp .benchmark-results/baseline.json .benchmark-results/startup-results-baseline.json
          fi

      - name: Comment PR with benchmark results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = '.benchmark-results/startup-results.json';

            if (!fs.existsSync(path)) {
              console.log('No benchmark results found');
              return;
            }

            const results = JSON.parse(fs.readFileSync(path, 'utf8'));
            const totalAvg = results.aggregated.total?.avg || 'N/A';
            const timestamp = results.timestamp;

            const comment = `## ðŸ“Š Startup Benchmark Results

            **Total Activation Time:** ${totalAvg}ms
            **Timestamp:** ${timestamp}

            | Metric | Avg (ms) | Min (ms) | Max (ms) | Std Dev (ms) |
            |--------|----------|----------|----------|--------------|
            | Logger Init | ${results.aggregated.loggerInit?.avg || 'N/A'} | ${results.aggregated.loggerInit?.min || 'N/A'} | ${results.aggregated.loggerInit?.max || 'N/A'} | ${results.aggregated.loggerInit?.stdDev || 'N/A'} |
            | Commands Registered | ${results.aggregated.commandsRegistered?.avg || 'N/A'} | ${results.aggregated.commandsRegistered?.min || 'N/A'} | ${results.aggregated.commandsRegistered?.max || 'N/A'} | ${results.aggregated.commandsRegistered?.stdDev || 'N/A'} |
            | Save Handler Registered | ${results.aggregated.saveHandlerRegistered?.avg || 'N/A'} | ${results.aggregated.saveHandlerRegistered?.min || 'N/A'} | ${results.aggregated.saveHandlerRegistered?.max || 'N/A'} | ${results.aggregated.saveHandlerRegistered?.stdDev || 'N/A'} |
            | Context Deferred | ${results.aggregated.contextDeferred?.avg || 'N/A'} | ${results.aggregated.contextDeferred?.min || 'N/A'} | ${results.aggregated.contextDeferred?.max || 'N/A'} | ${results.aggregated.contextDeferred?.stdDev || 'N/A'} |
            | **Total** | **${totalAvg}** | ${results.aggregated.total?.min || 'N/A'} | ${results.aggregated.total?.max || 'N/A'} | ${results.aggregated.total?.stdDev || 'N/A'} |

            *Results based on ${results.runs} runs*
            `;

            const { owner, repo, number } = context.issue;
            const comments = await github.rest.issues.listComments({ owner, repo, issue_number: number });

            const botComment = comments.data.find(
              c => c.user.type === 'Bot' && c.body.includes('ðŸ“Š Startup Benchmark Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner, repo, comment_id: botComment.id, body: comment
              });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number: number, body: comment });
            }
