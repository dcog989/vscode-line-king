name: "Dependency Review"

on:
  pull_request:
    branches: ["main", "develop"]
  push:
    branches: ["main", "develop"]

permissions:
  contents: read
  pull-requests: write # Required to post comments

jobs:
  dependency-review:
    name: "Dependency Review"
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout code"
        uses: actions/checkout@v6

      - name: "Setup Bun"
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "latest"

      - name: "Install dependencies"
        run: bun install --frozen-lockfile

      # Bun audit returns exit code 1 on vulnerabilities, failing the job automatically
      - name: "Audit dependencies"
        run: bun pm audit

      # Use packprod to trigger the bundleSizeLimitPlugin in esbuild
      - name: "Bundle size check"
        run: bun run packprod

      - name: "Comment on PR"
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `
            ## üîç Dependency Review Results

            ### Security
            ‚úÖ Dependency audit completed.

            ### Bundle Size
            ‚úÖ Bundle size check passed.
            `;
            github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
            });
