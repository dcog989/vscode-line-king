name: 'Dependency Review'

on:
    pull_request:
    branches: ['main', 'develop']
    push:
        branches: ['main', 'develop']

permissions:
    contents: read

jobs:
    dependency-review:
        name: 'Dependency Review'
        runs-on: ubuntu-latest

        steps:
            - name: 'Checkout code'
              uses: actions/checkout@v4

            - name: 'Setup Bun'
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: 'latest'

            - name: 'Install dependencies'
              run: bun install

            - name: 'Audit dependencies'
              run: bun pm audit

            - name: 'Check for high/critical vulnerabilities'
              run: |
                  echo "Checking for security vulnerabilities..."
                  bun pm audit --json > audit.json || true

                  if [ -f audit.json ]; then
                      echo "‚úÖ No vulnerabilities found"
                  else
                      echo "‚ö†Ô∏è Potential vulnerabilities detected"
                      cat audit.json
                      exit 1
                  fi

            - name: 'Bundle size check'
              run: bun run size

            - name: 'Comment on PR'
              if: github.event == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const comment = `
                      ## üîç Dependency Review Results

                      ### Security
                      ‚úÖ Dependency audit completed
                      No high/critical vulnerabilities found

                      ### Bundle Size
                      ‚úÖ Bundle size check passed
                      Bundle is within 400KB limit
                      `;
                      github.rest.issue.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number, body: comment });
                  github-token: ${{ secrets.GITHUB_TOKEN }}
